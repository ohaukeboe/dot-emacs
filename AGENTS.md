# AGENTS.md

This file provides guidance to coding agents when working with code in this repository.

## Repository Overview

This is a NixOS and Home Manager configuration repository managing system configurations, user environments, and a comprehensive Emacs setup. The configuration uses Nix flakes and supports multiple systems (x86_64-linux, aarch64-linux, aarch64-darwin) and multiple machines.

## Common Commands

### Home Manager Operations
```bash
# Switch home-manager configuration (standalone)
home-manager switch --flake .#default --impure -b backup
# or use the fish alias:
hs

# Build without switching
nix build .#homeConfigurations.oskar@x86_64-linux.activationPackage
```

### NixOS Operations (system-level)
```bash
# Rebuild NixOS system
sudo nixos-rebuild switch --flake .#<hostname>
# where <hostname> is: x13-laptop, work-laptop, or x1laptop

# Test configuration without switching
sudo nixos-rebuild test --flake .#<hostname>
```

### Formatting
```bash
# Format all nix files
nix fmt

# Check formatting
nix flake check
```

### Emacs Configuration
The Emacs configuration is written in literate org-mode at `workstation/emacs/config.org`. It uses org-babel to tangle elisp code.

- The init.el at `workstation/emacs/init.el` automatically tangles config.org if it's newer than the compiled config.el
- After editing config.org, Emacs will auto-tangle on save (via local variables)
- The configuration uses `use-package` with nix-managed packages
- LSP mode is compiled with `LSP_USE_PLISTS=true` for performance

## Architecture

### Flake Structure

**Entry point**: `flake.nix` - Defines all inputs, outputs, and system configurations

**Key outputs**:
- `nixosConfigurations.*` - Full NixOS system configurations for each machine
- `homeConfigurations.*` - Standalone Home Manager configurations for various systems
- `packages.*` - Build outputs including home activation packages
- `formatter.*` - Code formatting via treefmt

### Configuration Layers

The configuration is organized in distinct layers:

1. **System layer** (`system/`)
   - `system/default.nix` - NixOS system configuration (boot, desktop, services)
   - `system/home.nix` - System-specific home-manager additions (Linux desktop apps)
   - Enables COSMIC desktop, virtualization (libvirt, docker, podman), services

2. **Workstation layer** (`workstation/`)
   - `workstation/home.nix` - Main home-manager configuration
   - Contains: Emacs setup, development tools, shell configuration (fish), git setup
   - Platform-aware: distinguishes between Linux/Darwin, NixOS/standalone
   - `workstation/emacs/` - Complete Emacs configuration including literate config.org

3. **Machine layer** (`machines/`)
   - `machines/<hostname>.nix` - Hardware-specific NixOS configurations
   - Generated by nixos-generate-config, defines filesystems, kernel modules, hardware

4. **Common layer** (`common/`)
   - `common/caches.nix` - Nix cache configuration (nixos cache, nix-community)
   - `common/secure-boot.nix` - Secure boot setup via lanzaboote
   - `common/unfree-predicates.nix` - Allows specific unfree packages

5. **Library layer** (`lib/`)
   - `lib/mkHomeConfiguration.nix` - Function to create home-manager configurations
   - Handles overlays (emacs-overlay, nixGL), system-specific package sets

### Configuration Composition

**NixOS machines** compose:
- System configuration (system/default.nix)
- Hardware configuration (machines/<hostname>.nix)
- Home Manager as NixOS module (imports workstation/home.nix + system/home.nix)
- Common modules (caches, secure-boot via lanzaboote)
- Hardware-specific nixos-hardware modules where applicable

**Standalone Home Manager** configurations:
- Built via mkHomeConfiguration function
- Import workstation/home.nix and common/caches.nix
- Platform-aware overlays (emacs-overlay, nixGL for Linux)
- Mac-specific: includes mac-app-util for app integration

### Key Patterns

**Secrets Management**:
- Secrets stored in `secrets/` directory (git-crypt encrypted)
- Loaded into configurations via `secrets.json`
- Linked into home directory via home.file

**Platform Detection**:
- Uses `pkgs.stdenv.isLinux`, `pkgs.stdenv.isDarwin` for platform-specific config
- `isNixos` parameter distinguishes NixOS from standalone home-manager

**Package Overlays**:
- emacs-overlay: Latest Emacs packages and unstable builds
- nixGL: OpenGL/Vulkan support for non-NixOS systems
- Custom package overrides (e.g., LSP packages with plists enabled)

**Emacs Integration**:
- Uses `emacsWithPackagesFromUsePackage` to manage packages declaratively
- Parses config.org to determine required packages
- Custom build overrides for LSP packages with performance flags
- Treesit grammars included for all languages

## Development Environment

### Language Toolchains Available

The configuration includes comprehensive development toolchains:
- **Python**: python313 with LSP, ruff, mypy, scientific stack (matplotlib, scipy, pandas)
- **Rust**: rustup for full toolchain management
- **Go**: go, gopls, golangci-lint-langserver
- **Java/Kotlin**: JDK, Maven, Gradle, kotlin-language-server
- **C/C++**: clang-tools, clangd, gcc, bear for compile_commands.json generation
- **C#**: omnisharp-roslyn
- **JavaScript/TypeScript**: node, typescript, vscode-langservers-extracted, eslint
- **Nix**: nil LSP, nixfmt-rfc-style
- **Terraform**: terraform, terraform-ls

### Shell Environment

Default shell is **fish** with:
- starship prompt (using nerd-font-symbols preset)
- zoxide for directory jumping
- atuin for shell history with sync
- direnv with nix-direnv integration
- Aliases: `hs` for home-manager switch, `edit` for emacsclient

### AI Tooling

Multiple AI coding assistants configured:
- **Claude Code** with ACP (claude-code, claude-code-acp)
- **Aider** with config at `.aider.conf.yml` (uses Claude Sonnet 4.5 via OpenRouter)
- **Goose CLI** (goose-cli)
- **OpenCode** (opencode)
- **Copilot** integration in Emacs

Agent configuration files:
- `workstation/agents-global.md` - Shared agent directives
- Symlinked to `~/.config/agents/AGENTS.md`, `~/.config/opencode/AGENTS.md`, `~/.config/claude/CLAUDE.md`

## Important Notes

### Emacs LSP Performance
LSP packages are built with `LSP_USE_PLISTS=true` for significant performance improvements. This affects:
- lsp-mode, lsp-ui, dap-mode, consult-lsp, lsp-treemacs, lsp-java, lsp-docker

The environment variable is also set in sessionVariables.

### Unfree Packages
Only specific unfree packages are allowed via `common/unfree-predicates.nix`. To add new unfree packages, add them to this list.

### Git Configuration
- Signing with SSH keys via 1Password (op-ssh-sign)
- Multiple email addresses based on directory (gitdir conditional includes)
- Default: ohaukeboe@pm.me
- For knowit projects: oskar.haukeboe@knowit.no

### Services
Several systemd user services auto-start:
- `protonmail-bridge` - ProtonMail IMAP/SMTP bridge
- `davmail` - Exchange gateway for email

### Virtualization
Rootless Docker and Podman are both enabled with:
- BTRFS storage for Docker
- Auto-pruning enabled
- DNS configuration for container networking
